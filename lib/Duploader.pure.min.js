function Duploader(e){this.config=this.build_config(e),this.check_config()&&(this.runtime=this.build_runtime(),this.init())}Duploader.prototype.build_config=function(e){var i={multiple:!1,debug:!1,chunk:!1,chunk_size:2097152,resume_broken:!1,accept_mime:null,extend_limited:null,size_limited:null,btn_add:null,btn_upload:null,upload_url:null,upload_type:"websocket"};if(e)for(var t in e)i[t]=e[t];return i},Duploader.prototype.build_runtime=function(){var e={_id:0,socket:null,btn_add:null,btn_upload:null,selector:null,uploading:!1,file_id:null,file_list:[],upload_count:0,upload_result:[]};return e},Duploader.prototype.check_config=function(){if(!this.config.upload_url||!this.config.btn_add||!this.config.btn_upload)return this.error("参数配置错误：upload_url、btn_add、btn_upload不能为空"),!1;if(!document.getElementById(this.config.btn_add))return this.error("参数配置错误：btn_add参数配置ID有误，未能找到相应的DOM节点"),!1;if(!document.getElementById(this.config.btn_upload))return this.error("参数配置错误：btn_upload参数配置ID有误，未能找到相应的DOM节点"),!1;if(this.config.multiple){if(!this.config.on_file_add||!this.config.on_file_add instanceof Function)return this.error("参数配置错误：multiple上传模式时必须实现on_file_add函数"),!1;if(!this.config.on_file_change||!this.config.on_file_change instanceof Function)return this.error("参数配置错误：multiple上传模式时必须实现on_file_change函数"),!1;if(!this.config.on_file_remove||!this.config.on_file_remove instanceof Function)return this.error("参数配置错误：multiple上传模式时必须实现on_file_remove函数"),!1}return!0},Duploader.prototype.debug=function(e){this.config.debug&&(e instanceof Object?console.log("Duploader【%s】:%o",this.runtime._id,e):console.log("Duploader【%s】:%s",this.runtime._id,e))},Duploader.prototype.error=function(e){this.runtime?e instanceof Object?console.error("Duploader【%s】:%o",this.runtime._id,e):console.error("Duploader【%s】:%s",this.runtime._id,e):console.error(e),this.config.on_error&&this.config.on_error instanceof Function&&this.config.on_error(e)},Duploader.prototype.alert=function(e){e instanceof Object?console.warn("Duploader【%s】:%o",this.runtime._id,e):console.warn("Duploader【%s】:%s",this.runtime._id,e),this.config.on_alert&&this.config.on_alert instanceof Function?this.config.on_alert(e):alert(e)},Duploader.prototype.init=function(){this.runtime.btn_add=document.getElementById(this.config.btn_add),this.runtime.btn_upload=document.getElementById(this.config.btn_upload),this.runtime._id=(new Date).getTime()+Math.floor(100*Math.random());var e=document.createElement("input");e.id="file_"+this.runtime._id,e.type="file",e.style.display="none",this.config.accept_mime&&e.setAttribute("accept",this.config.accept_mime),this.runtime.btn_add.parentNode.insertBefore(e,this.runtime.btn_add),this.runtime.selector=document.getElementById("file_"+this.runtime._id),this.runtime.btn_add.addEventListener("click",this.open_select.bind(this)),this.runtime.btn_upload.addEventListener("click",this.upload.bind(this)),this.runtime.selector.addEventListener("change",this.file_selected.bind(this))},Duploader.prototype.open_select=function(e,i){return this.debug("open_select"),this.runtime.uploading?(this.alert("文件已经在上传了"),!1):(i&&this.runtime.selector.setAttribute("file_id",i),this.runtime.selector.value="",void this.runtime.selector.dispatchEvent(new Event("click")))},Duploader.prototype.file_selected=function(e){var i=this.runtime.selector.files[0];return i?this.check_file_extend(i)&&this.check_file_size(i)?this.config.on_file_selected&&this.config.on_file_selected instanceof Function&&!this.config.on_file_selected(i)?!1:(i.begin_index=this.get_file_broken_point(i),void(this.config.multiple?this.runtime.selector.getAttribute("file_id")&&0!=this.runtime.selector.getAttribute("file_id")?(i.id=this.runtime.selector.getAttribute("file_id"),this.file_changed(e,i)):(i.id=(new Date).getTime(),this.file_added(e,i)):this.runtime.file_id?(i.id=this.runtime.file_id,this.file_changed(e,i)):(i.id=(new Date).getTime(),this.file_added(e,i)))):!1:(this.error("获取文件信息失败"),!1)},Duploader.prototype.file_added=function(e,i){this.debug("file_added"),this.runtime.file_list.push(i),this.config.multiple||(this.runtime.file_id=i.id),this.config.on_file_add&&this.config.on_file_add instanceof Function?this.config.on_file_add(this,i):this.file_added_show(i)},Duploader.prototype.file_added_show=function(e){var i=document.createElement("span");i.id="file_info_"+e.id,i.innerText=e.name,this.runtime.btn_add.parentNode.insertBefore(i,this.runtime.btn_add)},Duploader.prototype.file_change=function(e){var i=e.currentTarget,t=i.getAttribute("file_id");t?this.open_select(e,t):this.error("file_id异常")},Duploader.prototype.file_changed=function(e,i){if(this.debug("file_changed"),this.config.multiple){for(var t=null,n=0;n<this.runtime.file_list.length;n++)if(this.runtime.file_list[n].id==i.id){this.runtime.file_list[n]=i,t=n;break}}else this.runtime.file_list[0]=i;this.runtime.selector.setAttribute("file_id",0),this.config.on_file_change&&this.config.on_file_change instanceof Function?this.config.on_file_change(this,i,t):this.file_changed_show(i)},Duploader.prototype.file_changed_show=function(e){var i=document.getElementById("file_info_"+e.id);i&&(i.innerText=e.name)},Duploader.prototype.file_remove=function(e){var i=e.currentTarget,t=i.getAttribute("file_id");t?this.file_removed(t):this.error("file_id异常")},Duploader.prototype.file_removed=function(e){this.debug("file_removed");for(var i=null,t=null,n=[],o=0;o<this.runtime.file_list.length;o++)this.runtime.file_list[o].id==e?(i=this.runtime.file_list[o],t=o):n.push(this.runtime.file_list[o]);this.runtime.file_list=n,this.config.on_file_remove&&this.config.on_file_remove instanceof Function&&this.config.on_file_remove(this,i,t)},Duploader.prototype.upload=function(e){return this.runtime.uploading?(this.alert("文件已经在上传了"),!1):void(this.runtime.file_list.length>0?(this.debug("upload begin"),this.runtime.uploading=!0,"websocket"!=this.config.upload_type||this.runtime.socket?this.file_upload(0):this.websocket_init(function(){this.file_upload(0)}.bind(this))):this.alert("请先选择需要上传文件 ！"))},Duploader.prototype.file_upload=function(e){if(this.config.chunk){var i=this.runtime.file_list[e],t=Math.ceil(i.size/this.config.chunk_size);i.begin_index?this.file_slice_upload(e,t,i.begin_index):this.file_slice_upload(e,t)}else this.file_whole_upload(e);this.config.on_upload_begin&&this.config.on_upload_begin instanceof Function&&this.config.on_upload_begin(this,i)},Duploader.prototype.file_uploaded=function(e){this.runtime.upload_count+=1;var i={file_index:e.file_index,file_name:e.name,file_path:e.real_url};this.runtime.upload_result.push(i),this.remove_file_broken_point(e),this.config.on_file_upload_finish&&this.config.on_file_upload_finish instanceof Function&&this.config.on_file_upload_finish(this.runtime.upload_count,i),this.runtime.upload_count<this.runtime.file_list.length?this.file_upload(this.runtime.upload_count):this.file_list_uploaded()},Duploader.prototype.file_list_uploaded=function(){if(this.debug("file upload finish"),this.runtime.uploading=!1,this.config.on_upload_finish&&this.config.on_upload_finish instanceof Function?this.config.on_upload_finish(this.config.multiple?this.runtime.upload_result:this.runtime.upload_result[0]):this.alert("上传完毕"),this.runtime.file_list=[],this.runtime.upload_count=0,this.runtime.upload_result=[],!this.config.multiple){var e=document.getElementById("file_info_"+this.runtime.file_id);e&&e.parentNode.removeChild(e),this.runtime.file_id=null}},Duploader.prototype.file_whole_upload=function(e){var i=this.runtime.file_list[e],t=new window.FileReader;t.readAsDataURL(i),t.onloadend=function(){var n=t.result.lastIndexOf(",")+1;this.file_send({file_index:e,name:i.name,size:i.size,start:0,end:i.size,index:0,total:1,data:t.result.substr(n)})}.bind(this)},Duploader.prototype.file_slice_upload=function(e,i,t){if(t+1>i)return void console.error("文件分片分片错误!");var n=this.runtime.file_list[e],t=t?t:0,o=t*this.config.chunk_size,s=Math.min(n.size,o+this.config.chunk_size),r=new window.FileReader;r.readAsDataURL(n.slice(o,s)),r.onloadend=function(){var l=r.result.lastIndexOf(",")+1;this.file_send({file_index:e,name:n.name,size:n.size,start:o,end:s,index:t,total:i,data:r.result.substr(l)})}.bind(this)},Duploader.prototype.file_slice_uploaded=function(e){return 1!=e.result?void this.alert("上传过程出现错误！"):(e.index+1==e.total?this.file_uploaded(e):(this.record_file_broken_point(e),this.file_slice_upload(e.file_index,e.total,e.index+1)),void(this.config.on_file_slice_finish&&this.config.on_file_slice_finish instanceof Function&&this.config.on_file_slice_finish(this,e)))},Duploader.prototype.file_send=function(e){"websocket"==this.config.upload_type&&this.runtime.socket?this.websocket_send(e):this.post_send(e)},Duploader.prototype.websocket_init=function(e){this.runtime.socket||(this.runtime.socket=new WebSocket(this.config.upload_url),this.runtime.socket.onopen=function(i){this.debug("websocket 打开成功"),e()}.bind(this),this.runtime.socket.onmessage=function(e){this.debug("websocket 收到服务器端数据"),this.websocket_message(e.data)}.bind(this),this.runtime.socket.onclose=function(e){this.debug("websocket 连接关闭")}.bind(this),this.runtime.socket.onerror=function(e){this.error("websocket 出现错误")}.bind(this))},Duploader.prototype.websocket_close=function(){this.runtime.socket?this.runtime.socket.close():this.debug("websocket 未创建")},Duploader.prototype.websocket_send=function(e){this.debug(e),this.runtime.socket&&this.runtime.socket.readyState!=this.runtime.socket.CLOSING&&this.runtime.socket.readyState!=this.runtime.socket.CLOSED?this.runtime.socket.send(JSON.stringify(e)):this.debug("websocket 未创建或者已经关闭")},Duploader.prototype.websocket_message=function(e){this.debug(e),this.file_slice_uploaded(JSON.parse(e))},Duploader.prototype.post_send=function(e){this.debug(e);var i=new XMLHttpRequest;if(!i)return this.error("Ajax请求初始化失败!"),!1;i.onreadystatechange=function(){switch(i.readyState){case 1:this.debug("ajax打开，准备上传");break;case 4:200==i.status?(this.debug("ajax 收到服务器端数据"),this.post_message(JSON.parse(i.response))):this.error("上传过程出现错误,状态:"+i.status)}}.bind(this),i.error=function(){this.error("上传过程出现错误")}.bind(this);var t=new FormData;if(t){for(var n in e)t.append(n,e[n]);i.open("POST",this.config.upload_url,!0),i.send(t)}else this.error("上传过程出现错误")},Duploader.prototype.post_message=function(e){this.debug(e),e.file_index=parseInt(e.file_index),e.size=parseInt(e.size),e.start=parseInt(e.start),e.end=parseInt(e.end),e.index=parseInt(e.index),e.total=parseInt(e.total),this.file_slice_uploaded(e)},Duploader.prototype.check_file_extend=function(e){if(this.config.extend_limited&&this.config.extend_limited.length>0){for(var i=e.name,t=i.substring(i.lastIndexOf(".")+1),n=!1,o="",s=0;s<this.config.extend_limited.length;s++)o+=o?","+this.config.extend_limited[s]:this.config.extend_limited[s],t==this.config.extend_limited[s]&&(n=!0);return n?!0:(this.alert("文件类型不符合要求,后缀名只能为："+o),!1)}return!0},Duploader.prototype.check_file_size=function(e){if(this.config.size_limited&&this.config.size_limited>0){var i=e.size;return i>this.config.size_limited?(this.alert("文件大小不符合要求,最大只能为："+this.get_friendly_size(this.config.size_limited)),!1):!0}return!0},Duploader.prototype.get_friendly_size=function(e){var i=1024,t=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],n=Math.floor(Math.log(this.config.size_limited)/Math.log(i));return result=e/Math.pow(i,n)+" "+t[n]},Duploader.prototype.get_file_broken_point=function(e){if(!this.config.chunk||!this.config.resume_broken)return 0;if(window.localStorage){var i=window.btoa(escape(e.name)+"|"+e.size),t=localStorage.getItem(i);if(t){this.debug(t);var n=JSON.parse(t);return n.index+1}return 0}},Duploader.prototype.record_file_broken_point=function(e){if(this.config.chunk&&this.config.resume_broken&&window.localStorage&&window.localStorage){var i=window.btoa(escape(e.name)+"|"+e.size);localStorage.setItem(i,JSON.stringify(e))}},Duploader.prototype.remove_file_broken_point=function(e){if(this.config.chunk&&this.config.resume_broken&&window.localStorage&&window.localStorage){var i=window.btoa(escape(e.name)+"|"+e.size);localStorage.removeItem(i)}};