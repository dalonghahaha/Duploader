function Duploader(e){this.build_config(e),this.check_config()&&this.check_environment()&&(this.build_runtime(),this.build_uploader())}Duploader.prototype.set_config=function(e,t,i){Object.defineProperty(e,t,{value:i,writable:!1,configurable:!1,enumerable:!1})},Duploader.prototype.build_config=function(e){var t={multiple:!1,debug:!1,chunk:!1,chunk_size:2097152,resume_broken:!1,accept_mime:null,extend_limited:null,size_limited:null,btn_open:null,upload_url:null,upload_type:"websocket"};if(e)for(var i in e)t[i]=e[i];this.config=Object.create({});for(var i in t)this.set_config(this.config,i,t[i])},Duploader.prototype.build_runtime=function(){this.runtime={_id:0,instance:null,socket:null,uploading:!1,file_id:null,file_list:[],upload_count:0,upload_result:[]}},Duploader.prototype.check_config=function(){return this.debug(this.config),!0},Duploader.prototype.check_environment=function(){return!0},Duploader.prototype._event=["ready","file_select","file_add","file_change","file_remove","upload_begin","upload_finish","result"],Duploader.prototype.on=function(e,t){this.index_of(this._event,e)?t&&t instanceof Function?(this.debug("register on_uploader_"+e),this["on_uploader_"+e]=t):this.error("注册函数参数错误"):this.warn("该事件不支持")},Duploader.prototype.trigger=function(e,t){return this["on_uploader_"+e]?!this["on_uploader_"+e]instanceof Function?!1:(this.debug("trigger on_uploader_"+e),this["on_uploader_"+e].apply(this,t)):!1},Duploader.prototype.debug=function(e){this.config.debug&&(e instanceof Object?console.log("Duploader【%s】:%o",this.format_date(new Date,"yyyy-M-dd hh:mm:ss S"),e):console.log("Duploader【%s】:%s",this.format_date(new Date,"yyyy-M-dd hh:mm:ss S"),e))},Duploader.prototype.error=function(e){e instanceof Object?console.error("Duploader【%s】:%o",this.format_date(new Date,"yyyy-M-dd hh:mm:ss S"),e):console.error("Duploader【%s】:%s",this.format_date(new Date,"yyyy-M-dd hh:mm:ss S"),e)},Duploader.prototype.warn=function(e){e instanceof Object?console.warn("Duploader【%s】:%o",this.format_date(new Date,"yyyy-M-dd hh:mm:ss S"),e):console.warn("Duploader【%s】:%s",this.format_date(new Date,"yyyy-M-dd hh:mm:ss S"),e)},Duploader.prototype.alert=function(e){alert(e)},Duploader.prototype.has_class=function(e,t){return t=t||"",0==t.replace(/\s/g,"").length?!1:new RegExp(" "+t+" ").test(" "+e.className+" ")},Duploader.prototype.add_class=function(e,t){this.has_class(e,t)||(e.className=""==e.className?t:e.className+" "+t)},Duploader.prototype.remove_class=function(e,t){if(this.has_class(e,t)){for(var i=" "+e.className.replace(/[\t\r\n]/g,"")+" ";i.indexOf(" "+t+" ")>=0;)i=i.replace(" "+t+" "," ");e.className=i.replace(/^\s+|\s+$/g,"")}},Duploader.prototype.index_of=function(e,t){var i=e.join();return i.indexOf(t)>=0},Duploader.prototype.random_of=function(e){var t=e.length,i=Math.floor(Math.random()*t);return e[i]},Duploader.prototype.format_time=function(e){var t=[parseInt(e/60/60),parseInt(e/60%60),e%60].join(":");return t.replace(/\b(\d)\b/g,"0$1")},Duploader.prototype.format_percent=function(e,t){return t?Math.round(e/t*1e4)/100:0},Duploader.prototype.format_date=function(e,t){var i={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length)));for(var s in i)new RegExp("("+s+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?i[s]:("00"+i[s]).substr((""+i[s]).length)));return t},Duploader.prototype.format_size=function(e){var t=1024,i=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],s=Math.floor(Math.log(e)/Math.log(t)),n=e/Math.pow(t,s);return Math.round(100*n)/100+" "+i[s]},Duploader.prototype.async_get=function(e,t,i){this.debug(t);var s=new XMLHttpRequest;if(!s)return this.error("Ajax请求初始化失败!"),!1;s.responseType="json",s.onreadystatechange=function(){switch(s.readyState){case 1:this.debug("ajax打开，准备上传");break;case 4:200==s.status?(this.debug("ajax 收到服务器端数据"),this.debug(s.response),s.response?i(s.response):this.error("ajax返回格式错误")):this.error("上传过程出现错误,状态:"+s.status)}}.bind(this),s.error=function(){this.error("提交过程出现错误")}.bind(this),e+="?time="+(new Date).getTime();for(var n in t)e+="&"+n+"="+t[n];s.open("GET",e,!0),s.send(null)},Duploader.prototype.async_post=function(e,t,i){this.debug(t);var s=new XMLHttpRequest;if(!s)return this.error("Ajax请求初始化失败!"),!1;s.responseType="json",s.onreadystatechange=function(){switch(s.readyState){case 1:this.debug("ajax打开，准备上传");break;case 4:200==s.status?(this.debug("ajax 收到服务器端数据"),i(s.response)):this.error("上传过程出现错误,状态:"+s.status)}}.bind(this),s.error=function(){this.error("提交过程出现错误")}.bind(this);var n=new FormData;if(n){for(var o in t)n.append(o,t[o]);s.open("POST",e,!0),s.send(n)}else this.error("提交过程出现错误")},Duploader.prototype.css_link=function(e){var t=document.getElementsByTagName("head")[0],i=document.createElement("link");return i.setAttribute("rel","stylesheet"),i.setAttribute("type","text/css"),i.href=e,t.appendChild(i),i},Duploader.prototype.css_ready=function(e,t){function i(){try{return e&&e[r]&&e[r][o]&&e[r][o][0]}catch(t){return!1}}var s=document,n=s.createStyleSheet,o=n?"rules":"cssRules",r=n?"styleSheet":"sheet",l=s.getElementsByTagName("link");e||(e=l[l.length-1]),function a(){i()&&setTimeout(t,0)||setTimeout(a,100)}()},Duploader.prototype._class={BASE:"Duploader",HIDDEN:"Duploader-Hidden",CLEAR:"Duploader-Clear",MASK:"Mask",OPERATION:"operation",TITLE:"title",FILE_LIST:"file-list",FILE:"file",FILE_SECTION:"file-section",FILE_INFO:"file-info",FILE_CHANGE:"file-change",FILE_REMOVE:"file-remove",PROGRESS_SECTION:"progress-section",PROGRESS_BAR:"progress-bar",PROGRESS_INFO:"progress-info",PROGRESS_TEXT:"progress-text",BUTTON:"button",BUTTON_BASE:"button-base",BUTTON_ADD:"button-add",BUTTON_UPLOAD:"button-upload",BUTTON_CANCEL:"button-cancel"},Duploader.prototype.create_element=function(e,t){var i=document.createElement("div");return i.className=e instanceof Array?e.join(" "):e,t&&(i.innerText=t),i},Duploader.prototype.query_element=function(e){if(e){var t="."+e,i=this.runtime.instance.querySelector(t);return i.has_class=function(e){return 0==e.replace(/\s/g,"").length?!1:new RegExp(" "+e+" ").test(" "+this.className+" ")},i.add_class=function(e){this.has_class(e)||(this.className=""==this.className?e:this.className+" "+e)},i.remove_class=function(e){if(this.has_class(e)){for(var t=" "+this.className.replace(/[\t\r\n]/g,"")+" ";t.indexOf(" "+e+" ")>=0;)t=t.replace(" "+e+" "," ");this.className=t.replace(/^\s+|\s+$/g,"")}},i}return null},Duploader.prototype.build_uploader=function(){this.runtime.instance=this.create_element(this._class.BASE),this.runtime.instance.appendChild(this.create_element([this._class.MASK,this._class.HIDDEN])),this.runtime.instance.appendChild(this.build_operation()),document.body.appendChild(this.runtime.instance),setTimeout(this.on_uploader_build.bind(this),100)},Duploader.prototype.build_operation=function(){var e=this.create_element([this._class.OPERATION,this._class.HIDDEN]),t=this.create_element(this._class.TITLE,"请选择需要上传的文件:"),i=this.create_element([this._class.FILE_LIST,this._class.HIDDEN]),s=this.build_button();return e.appendChild(t),e.appendChild(i),e.appendChild(s),e},Duploader.prototype.build_button=function(){var e=this.create_element(this._class.BUTTON);return e.appendChild(this.create_element([this._class.BUTTON_BASE,this._class.BUTTON_ADD],"添加文件")),e.appendChild(this.create_element([this._class.BUTTON_BASE,this._class.BUTTON_UPLOAD],"上  传")),e.appendChild(this.create_element([this._class.BUTTON_BASE,this._class.BUTTON_CANCEL],"取  消")),this.runtime._id=(new Date).getTime()+Math.floor(100*Math.random()),this.runtime.selector=document.createElement("input"),this.runtime.selector.id="file_"+this.runtime._id,this.runtime.selector.type="file",this.runtime.selector.style.display="none",this.config.accept_mime&&this.runtime.selector.setAttribute("accept",this.config.accept_mime),e.appendChild(this.runtime.selector),e},Duploader.prototype.build_file_info=function(e){var t=this.create_element(this._class.FILE);t.id="file_section_"+e.id,t.appendChild(this.build_file_section(e)),t.appendChild(this.build_progress_section(e)),this.query_element(this._class.FILE_LIST).appendChild(t),this.query_element(this._class.FILE_LIST).remove_class(this._class.HIDDEN)},Duploader.prototype.build_file_section=function(e){var t=this.create_element(this._class.FILE_SECTION),i=this.create_element(this._class.FILE_INFO,e.name+"("+this.format_size(e.size)+")");if(i.id="file_info_"+e.id,t.appendChild(i),this.config.multiple){var s=this.create_element(this._class.FILE_REMOVE,"删  除");s.setAttribute("file_id",e.id),t.appendChild(s);var n=this.create_element(this._class.FILE_CHANGE,"修  改");n.setAttribute("file_id",e.id),t.appendChild(n)}return t.appendChild(this.create_element(this._class.CLEAR)),t},Duploader.prototype.build_progress_section=function(e){var t=this.create_element([this._class.PROGRESS_SECTION,this._class.HIDDEN]);t.id="progress_section_"+e.id;var i=this.create_element(this._class.PROGRESS_BAR),s=this.create_element(this._class.PROGRESS_INFO);s.id="progress_info_"+e.id,i.appendChild(s);var n=this.create_element(this._class.PROGRESS_TEXT,"0%");return n.id="progress_text_"+e.id,t.appendChild(i),t.appendChild(n),t.appendChild(this.create_element(this._class.CLEAR)),t},Duploader.prototype.change_file_info=function(e){var t=document.getElementById("file_info_"+e.id);t&&(t.innerText=e.name),this.runtime.selector.setAttribute("file_id",0)},Duploader.prototype.remove_file_info=function(e){var t=document.getElementById("file_section_"+e.id);t.parentNode.removeChild(t),0==this.runtime.file_list.length&&this.query_element(this._class.FILE_LIST).add_class(this._class.HIDDEN)},Duploader.prototype.change_progress_info=function(e,t){this.remove_class(document.getElementById("progress_section_"+e),this._class.HIDDEN),document.getElementById("progress_info_"+e).style.width=t+"%",document.getElementById("progress_text_"+e).innerText=t+"%"},Duploader.prototype.on_uploader_build=function(){this.trigger("ready"),this.delegate_document_event(),this.delegate_uploader_event()},Duploader.prototype.delegate=function(e,t,i){var s=this.runtime.instance;s.addEventListener(t,function(t){for(var n=t.target||t.srcElement,o=[n.className];n.parentElement&&n!=s;)o.push(n.parentElement.className),n=n.parentElement;if(e){var n=t.target||t.srcElement;this.index_of(o,e)&&i(t)}else i(t);return!1}.bind(this))},Duploader.prototype.delegate_document_event=function(){},Duploader.prototype.delegate_uploader_event=function(){var e=document.getElementById(this.config.btn_open);e.addEventListener("click",this.open_uploader.bind(this)),this.runtime.selector.addEventListener("change",this.file_selected.bind(this)),this.delegate(this._class.BUTTON_ADD,"click",this.open_select.bind(this)),this.delegate(this._class.BUTTON_UPLOAD,"click",this.upload.bind(this)),this.delegate(this._class.BUTTON_CANCEL,"click",this.close_uploader.bind(this)),this.delegate(this._class.FILE_CHANGE,"click",this.file_change.bind(this)),this.delegate(this._class.FILE_REMOVE,"click",this.file_remove.bind(this))},Duploader.prototype.open_uploader=function(e){this.query_element(this._class.MASK).style.width=document.body.scrollWidth+"px",this.query_element(this._class.MASK).style.height=document.body.scrollHeight+"px",this.query_element(this._class.OPERATION).style.left=(document.body.scrollWidth-600)/2+"px",this.query_element(this._class.OPERATION).style.top="200px",this.query_element(this._class.MASK).remove_class(this._class.HIDDEN),this.query_element(this._class.OPERATION).remove_class(this._class.HIDDEN)},Duploader.prototype.close_uploader=function(e){this.query_element(this._class.FILE_LIST).innerHTML="",this.runtime.uploading=!1,this.runtime.file_id=null,this.runtime.file_list=[],this.runtime.upload_count=0,this.runtime.upload_result=[],this.query_element(this._class.MASK).add_class(this._class.HIDDEN),this.query_element(this._class.OPERATION).add_class(this._class.HIDDEN),this.query_element(this._class.FILE_LIST).add_class(this._class.HIDDEN)},Duploader.prototype.open_select=function(e,t){return this.debug("event open_select"),this.runtime.uploading?(this.alert("文件已经在上传了"),!1):(t&&this.runtime.selector.setAttribute("file_id",t),this.runtime.selector.value="",void this.runtime.selector.dispatchEvent(new Event("click")))},Duploader.prototype.file_change=function(e){var t=e.target||e.srcElement,i=t.getAttribute("file_id");i?this.open_select(e,i):this.error("file_id异常")},Duploader.prototype.file_remove=function(e){var t=e.target||e.srcElement,i=t.getAttribute("file_id");i?this.file_removed(i):this.error("file_id异常")},Duploader.prototype.upload=function(e){return this.runtime.uploading?(this.alert("文件已经在上传了"),!1):void(this.runtime.file_list.length>0?(this.runtime.uploading=!0,"websocket"!=this.config.upload_type||this.runtime.socket?this.file_upload(0):this.websocket_init(function(){this.file_upload(0)}.bind(this))):this.alert("请先选择需要上传文件 ！"))},Duploader.prototype.file_whole_upload=function(e){var t=this.runtime.file_list[e],i=new window.FileReader;i.readAsDataURL(t),i.onloadend=function(){var s=i.result.lastIndexOf(",")+1;this.file_send({file_index:e,name:t.name,size:t.size,start:0,end:t.size,index:0,total:1,data:i.result.substr(s)})}.bind(this)},Duploader.prototype.file_slice_upload=function(e,t,i){if(i+1>t)return void console.error("文件分片分片错误!");var s=this.runtime.file_list[e],i=i?i:0,n=i*this.config.chunk_size,o=Math.min(s.size,n+this.config.chunk_size),r=new window.FileReader;r.readAsDataURL(s.slice(n,o)),r.onloadend=function(){var l=r.result.lastIndexOf(",")+1;this.file_send({file_index:e,name:s.name,size:s.size,start:n,end:o,index:i,total:t,data:r.result.substr(l)})}.bind(this)},Duploader.prototype.file_send=function(e){if(this.config.chunk)var t=this.runtime.file_list[e.file_index],i=parseFloat(e.index+1),s=parseFloat(e.total);this.change_progress_info(t.id,this.format_percent(i,s)),"websocket"==this.config.upload_type&&this.runtime.socket?this.websocket_send(e):this.post_send(e)},Duploader.prototype.check_file_extend=function(e){if(this.config.extend_limited&&this.config.extend_limited.length>0){for(var t=e.name,i=t.substring(t.lastIndexOf(".")+1),s=!1,n="",o=0;o<this.config.extend_limited.length;o++)n+=n?","+this.config.extend_limited[o]:this.config.extend_limited[o],i==this.config.extend_limited[o]&&(s=!0);return s?!0:(this.alert("文件类型不符合要求,后缀名只能为："+n),!1)}return!0},Duploader.prototype.check_file_size=function(e){if(this.config.size_limited&&this.config.size_limited>0){var t=e.size;return t>this.config.size_limited?(this.alert("文件大小不符合要求,最大只能为："+this.format_size(this.config.size_limited)),!1):!0}return!0},Duploader.prototype.get_file_broken_point=function(e){if(!this.config.chunk||!this.config.resume_broken)return 0;if(window.localStorage){var t=window.btoa(escape(e.name)+"|"+e.size),i=localStorage.getItem(t);if(i){this.debug(i);var s=JSON.parse(i);return s.index+1}return 0}},Duploader.prototype.record_file_broken_point=function(e){if(this.config.chunk&&this.config.resume_broken&&window.localStorage&&window.localStorage){var t=window.btoa(escape(e.name)+"|"+e.size);localStorage.setItem(t,JSON.stringify(e))}},Duploader.prototype.remove_file_broken_point=function(e){if(this.config.chunk&&this.config.resume_broken&&window.localStorage&&window.localStorage){var t=window.btoa(escape(e.name)+"|"+e.size);localStorage.removeItem(t)}},Duploader.prototype.websocket_init=function(e){this.runtime.socket||(this.runtime.socket=new WebSocket(this.config.upload_url),this.runtime.socket.onopen=function(t){this.debug("websocket open"),e()}.bind(this),this.runtime.socket.onmessage=function(e){this.debug("websocket recive data"),this.websocket_message(e.data)}.bind(this),this.runtime.socket.onclose=function(e){this.debug("websocket close")}.bind(this),this.runtime.socket.onerror=function(e){this.error("websocket error")}.bind(this))},Duploader.prototype.websocket_close=function(){this.runtime.socket?this.runtime.socket.close():this.debug("websocket no init")},Duploader.prototype.websocket_send=function(e){this.debug(e),this.runtime.socket&&this.runtime.socket.readyState!=this.runtime.socket.CLOSING&&this.runtime.socket.readyState!=this.runtime.socket.CLOSED?this.runtime.socket.send(JSON.stringify(e)):this.debug("websocket no init or is close")},Duploader.prototype.websocket_message=function(e){this.debug(e),this.file_slice_uploaded(JSON.parse(e))},Duploader.prototype.post_send=function(e){this.debug(e);var t=new XMLHttpRequest;if(!t)return this.error("Ajax init faild "),!1;t.onreadystatechange=function(){switch(t.readyState){case 1:this.debug("ajax open ready");break;case 4:200==t.status?(this.debug("ajax recive data"),this.post_message(JSON.parse(t.response))):this.error("ajax error,status:"+t.status)}}.bind(this),t.error=function(){this.error("ajax error")}.bind(this);var i=new FormData;if(i){for(var s in e)i.append(s,e[s]);t.open("POST",this.config.upload_url,!0),t.send(i)}else this.error("ajax error")},Duploader.prototype.post_message=function(e){this.debug(e),e.file_index=parseInt(e.file_index),e.size=parseInt(e.size),e.start=parseInt(e.start),e.end=parseInt(e.end),e.index=parseInt(e.index),e.total=parseInt(e.total),this.file_slice_uploaded(e)},Duploader.prototype.file_selected=function(e){var t=this.runtime.selector.files[0];return t?this.check_file_extend(t)&&this.check_file_size(t)?this.on_uploader_select&&this.on_uploader_select instanceof Function&&!this.on_uploader_select(t)?!1:(t.begin_index=this.get_file_broken_point(t),void(this.config.multiple?this.runtime.selector.getAttribute("file_id")&&0!=this.runtime.selector.getAttribute("file_id")?(t.id=this.runtime.selector.getAttribute("file_id"),this.file_changed(e,t)):(t.id=(new Date).getTime(),this.file_added(e,t)):this.runtime.file_id?(t.id=this.runtime.file_id,this.file_changed(e,t)):(t.id=(new Date).getTime(),this.file_added(e,t)))):!1:(this.error("获取文件信息失败"),!1)},Duploader.prototype.file_added=function(e,t){this.debug("event file_added"),this.runtime.file_list.push(t),this.config.multiple||(this.runtime.file_id=t.id),this.build_file_info(t),this.trigger("file_add",[t])},Duploader.prototype.file_changed=function(e,t){if(this.debug("event file_changed"),this.config.multiple){for(var i=null,s=0;s<this.runtime.file_list.length;s++)if(this.runtime.file_list[s].id==t.id){this.runtime.file_list[s]=t,i=s;break}}else this.runtime.file_list[0]=t;this.change_file_info(t),this.trigger("file_change",[t])},Duploader.prototype.file_removed=function(e){this.debug("event file_removed");for(var t=null,i=null,s=[],n=0;n<this.runtime.file_list.length;n++)this.runtime.file_list[n].id==e?(t=this.runtime.file_list[n],i=n):s.push(this.runtime.file_list[n]);this.runtime.file_list=s,this.remove_file_info(t),this.trigger("file_remove",[t])},Duploader.prototype.file_upload=function(e){if(this.debug("event file_upload"),this.config.chunk){{var t=this.runtime.file_list[e],i=Math.ceil(t.size/this.config.chunk_size);t.begin_index?t.begin_index:0}this.file_slice_upload(e,i,t.begin_index)}else this.file_whole_upload(e);this.trigger("upload_begin",[t])},Duploader.prototype.file_slice_uploaded=function(e){return this.debug("event file_slice_uploaded"),1!=e.result?void this.alert("上传过程出现错误！"):(e.index+1==e.total?this.file_uploaded(e):(this.record_file_broken_point(e),this.file_slice_upload(e.file_index,e.total,e.index+1)),void(this.config.on_file_slice_finish&&this.config.on_file_slice_finish instanceof Function&&this.config.on_file_slice_finish(this,e)))},Duploader.prototype.file_uploaded=function(e){this.debug("event file_uploaded"),this.runtime.upload_count+=1;var t={file_index:e.file_index,file_name:e.name,file_path:e.real_url};this.runtime.upload_result.push(t),this.remove_file_broken_point(e),this.trigger("upload_finish",[t]),this.runtime.upload_count<this.runtime.file_list.length?this.file_upload(this.runtime.upload_count):this.file_list_uploaded()},Duploader.prototype.file_list_uploaded=function(){this.debug("event file_list_uploaded"),this.config.multiple?this.trigger("result",[this.runtime.upload_result]):this.trigger("result",[this.runtime.upload_result[0]]),this.close_uploader()};