function Duploader(i){this.config=this.build_config(i),this.check_config()&&(this.runtime=this.build_runtime(),this.init())}Duploader.prototype.build_config=function(i){var e={multiple:!1,debug:!1,chunk:!1,chunk_size:2097152,resume_broken:!1,accept_mime:null,extend_limited:null,size_limited:null,btn_add:null,btn_upload:null,upload_url:null,upload_type:"websocket"};return e=$.extend(e,i)},Duploader.prototype.build_runtime=function(){var i={_id:0,socket:null,btn_add:null,btn_upload:null,selector:null,uploading:!1,file_id:null,file_list:[],upload_count:0,upload_result:[]};return i},Duploader.prototype.check_config=function(){if(!this.config.upload_url||!this.config.btn_add||!this.config.btn_upload)return this.error("参数配置错误：upload_url、btn_add、btn_upload不能为空"),!1;if(!document.getElementById(this.config.btn_add))return this.error("参数配置错误：btn_add参数配置ID有误，未能找到相应的DOM节点"),!1;if(!document.getElementById(this.config.btn_upload))return this.error("参数配置错误：btn_upload参数配置ID有误，未能找到相应的DOM节点"),!1;if(this.config.multiple){if(!this.config.on_file_add||!this.config.on_file_add instanceof Function)return this.error("参数配置错误：multiple上传模式时必须实现on_file_add函数"),!1;if(!this.config.on_file_change||!this.config.on_file_change instanceof Function)return this.error("参数配置错误：multiple上传模式时必须实现on_file_change函数"),!1;if(!this.config.on_file_remove||!this.config.on_file_remove instanceof Function)return this.error("参数配置错误：multiple上传模式时必须实现on_file_remove函数"),!1}return!0},Duploader.prototype.debug=function(i){this.config.debug&&(i instanceof Object?console.log("Duploader【%s】:%o",this.runtime._id,i):console.log("Duploader【%s】:%s",this.runtime._id,i))},Duploader.prototype.error=function(i){this.runtime?i instanceof Object?console.error("Duploader【%s】:%o",this.runtime._id,i):console.error("Duploader【%s】:%s",this.runtime._id,i):console.error(i),this.config.on_error&&this.config.on_error instanceof Function&&this.config.on_error(i)},Duploader.prototype.alert=function(i){i instanceof Object?console.warn("Duploader【%s】:%o",this.runtime._id,i):console.warn("Duploader【%s】:%s",this.runtime._id,i),this.config.on_alert&&this.config.on_alert instanceof Function?this.config.on_alert(i):alert(i)},Duploader.prototype.init=function(){this.runtime.btn_add=$("#"+this.config.btn_add),this.runtime.btn_upload=$("#"+this.config.btn_upload),this.runtime._id=(new Date).getTime()+Math.floor(100*Math.random());var i="file_"+this.runtime._id,e=$("<input>").attr("type","file").attr("id",i).attr("file_id",0).css("display","none");this.config.accept_mime&&e.attr("accept",this.config.accept_mime),this.runtime.btn_add.after(e),this.runtime.selector=$("#"+i),this.runtime.btn_add.on("click",this.open_select.bind(this)),this.runtime.btn_upload.on("click",this.upload.bind(this)),this.runtime.selector.on("change",this.file_selected.bind(this))},Duploader.prototype.open_select=function(i,e){return this.debug("open_select"),this.runtime.uploading?(this.alert("文件已经在上传了"),!1):(e&&this.runtime.selector.attr("file_id",e),void this.runtime.selector.trigger("click"))},Duploader.prototype.file_selected=function(i){var e=this.runtime.selector.get(0).files[0];return this.check_file_extend(e)&&this.check_file_size(e)?this.config.on_file_selected&&this.config.on_file_selected instanceof Function&&!this.config.on_file_selected(e)?!1:(e.begin_index=this.get_file_broken_point(e),void(this.config.multiple?0!=this.runtime.selector.attr("file_id")?(e.id=this.runtime.selector.attr("file_id"),this.file_changed(i,e)):(e.id=(new Date).getTime(),this.file_added(i,e)):this.runtime.file_id?(e.id=this.runtime.file_id,this.file_changed(i,e)):(e.id=(new Date).getTime(),this.file_added(i,e)))):!1},Duploader.prototype.file_added=function(i,e){this.debug("file_added"),this.runtime.file_list.push(e),this.config.multiple||(this.runtime.file_id=e.id),this.config.on_file_add&&this.config.on_file_add instanceof Function?this.config.on_file_add(this,e):this.file_added_show(e)},Duploader.prototype.file_added_show=function(i){var e=$("<span>").attr("id","file_info_"+i.id).text(i.name);this.runtime.btn_add.before(e)},Duploader.prototype.file_change=function(i){var e=$(i.currentTarget).attr("file_id");e?this.open_select(i,e):this.error("file_id异常")},Duploader.prototype.file_changed=function(i,e){this.debug("file_changed");for(var t=null,n=0;n<this.runtime.file_list.length;n++)if(this.runtime.file_list[n].id==e.id){this.runtime.file_list[n]=e,t=n;break}this.runtime.selector.attr("file_id",0),this.config.on_file_change&&this.config.on_file_change instanceof Function?this.config.on_file_change(this,e,t):file_changed_show(e)},Duploader.prototype.file_changed_show=function(i){$("#file_info_"+i.id).text(i.name)},Duploader.prototype.file_remove=function(i){var e=$(i.currentTarget).attr("file_id");e?this.file_removed(e):this.error("file_id异常")},Duploader.prototype.file_removed=function(i){this.debug("file_removed");for(var e=null,t=null,n=0;n<this.runtime.file_list.length;n++)if(this.runtime.file_list[n].id==i){e=this.runtime.file_list[n],t=n;break}var o=this.runtime.file_list.slice(0,t-1).concat(this.runtime.file_list.slice(t));this.runtime.file_list=o,this.config.on_file_remove&&this.config.on_file_remove instanceof Function&&this.config.on_file_remove(this,e,t)},Duploader.prototype.upload=function(i){return this.runtime.uploading?(this.alert("文件已经在上传了"),!1):void(this.runtime.file_list.length>0?(this.debug("upload begin"),this.runtime.uploading=!0,"websocket"!=this.config.upload_type||this.runtime.socket?this.file_upload(0):this.websocket_init(function(){this.file_upload(0)}.bind(this))):this.alert("请先选择需要上传文件 ！"))},Duploader.prototype.file_upload=function(i){if(this.config.chunk){var e=this.runtime.file_list[i],t=Math.ceil(e.size/this.config.chunk_size);e.begin_index?this.file_slice_upload(i,t,e.begin_index):this.file_slice_upload(i,t)}else this.file_whole_upload(i);this.config.on_upload_begin&&this.config.on_upload_begin instanceof Function&&this.config.on_upload_begin(this,e)},Duploader.prototype.file_uploaded=function(i){this.runtime.upload_count+=1;var e={file_index:i.file_index,file_name:i.name,file_path:i.real_url};this.runtime.upload_result.push(e),this.remove_file_broken_point(i),this.config.on_file_upload_finish&&this.config.on_file_upload_finish instanceof Function&&this.config.on_file_upload_finish(e),this.runtime.upload_count<this.runtime.file_list.length?this.file_upload(this.runtime.upload_count):this.file_list_uploaded()},Duploader.prototype.file_list_uploaded=function(){this.debug("file upload finish"),this.runtime.uploading=!1,this.config.on_upload_finish&&this.config.on_upload_finish instanceof Function?this.config.on_upload_finish(this.config.multiple?this.runtime.upload_result:this.runtime.upload_result[0]):this.alert("上传完毕"),this.runtime.file_list=[],this.runtime.upload_count=0,this.runtime.upload_result=[],this.config.multiple||($("#file_info_"+this.runtime.file_id).remove(),this.runtime.file_id=null)},Duploader.prototype.file_whole_upload=function(i){var e=this.runtime.file_list[i],t=new window.FileReader;t.readAsDataURL(e),t.onloadend=function(){var n=t.result.lastIndexOf(",")+1;this.file_send({file_index:i,name:e.name,size:e.size,start:0,end:e.size,index:0,total:1,data:t.result.substr(n)})}.bind(this)},Duploader.prototype.file_slice_upload=function(i,e,t){if(t+1>e)return void console.error("文件分片分片错误!");var n=this.runtime.file_list[i],t=t?t:0,o=t*this.config.chunk_size,s=Math.min(n.size,o+this.config.chunk_size),l=new window.FileReader;l.readAsDataURL(n.slice(o,s)),l.onloadend=function(){var r=l.result.lastIndexOf(",")+1;this.file_send({file_index:i,name:n.name,size:n.size,start:o,end:s,index:t,total:e,data:l.result.substr(r)})}.bind(this)},Duploader.prototype.file_slice_uploaded=function(i){return 1!=i.result?void this.alert("上传过程出现错误！"):(i.index+1==i.total?this.file_uploaded(i):(this.record_file_broken_point(i),this.file_slice_upload(i.file_index,i.total,i.index+1)),void(this.config.on_file_slice_finish&&this.config.on_file_slice_finish instanceof Function&&this.config.on_file_slice_finish(this,i)))},Duploader.prototype.file_send=function(i){"websocket"==this.config.upload_type&&this.runtime.socket?this.websocket_send(i):this.post_send(i)},Duploader.prototype.websocket_init=function(i){this.runtime.socket||(this.runtime.socket=new WebSocket(this.config.upload_url),this.runtime.socket.onopen=function(e){this.debug("websocket 打开成功"),i()}.bind(this),this.runtime.socket.onmessage=function(i){this.debug("websocket 收到服务器端数据"),this.websocket_message(i.data)}.bind(this),this.runtime.socket.onclose=function(i){this.debug("websocket 连接关闭")}.bind(this),this.runtime.socket.onerror=function(i){this.debug("websocket 出现错误")}.bind(this))},Duploader.prototype.websocket_close=function(){this.runtime.socket?this.runtime.socket.close():this.debug("websocket 未创建")},Duploader.prototype.websocket_send=function(i){this.debug(i),this.runtime.socket&&this.runtime.socket.readyState!=this.runtime.socket.CLOSING&&this.runtime.socket.readyState!=this.runtime.socket.CLOSED?this.runtime.socket.send(JSON.stringify(i)):this.debug("websocket 未创建或者已经关闭")},Duploader.prototype.websocket_message=function(i){this.debug(i),this.file_slice_uploaded(JSON.parse(i))},Duploader.prototype.post_send=function(i){this.debug(i),$.ajax({type:"post",dataType:"json",data:i,url:this.config.upload_url,success:function(i){this.post_message(i)}.bind(this),error:function(){this.debug("")}.bind(this)})},Duploader.prototype.post_message=function(i){this.debug(i),i.file_index=parseInt(i.file_index),i.size=parseInt(i.size),i.start=parseInt(i.start),i.end=parseInt(i.end),i.index=parseInt(i.index),i.total=parseInt(i.total),this.file_slice_uploaded(i)},Duploader.prototype.check_file_extend=function(i){if(this.config.extend_limited&&this.config.extend_limited.length>0){for(var e=i.name,t=e.substring(e.lastIndexOf(".")+1),n=!1,o="",s=0;s<this.config.extend_limited.length;s++)o+=o?","+this.config.extend_limited[s]:this.config.extend_limited[s],t==this.config.extend_limited[s]&&(n=!0);return n?!0:(this.alert("文件类型不符合要求,后缀名只能为："+o),!1)}return!0},Duploader.prototype.check_file_size=function(i){if(this.config.size_limited&&this.config.size_limited>0){var e=i.size;return e>this.config.size_limited?(this.alert("文件大小不符合要求,最大只能为："+this.get_friendly_size(this.config.size_limited)),!1):!0}return!0},Duploader.prototype.get_friendly_size=function(i){var e=1024,t=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],n=Math.floor(Math.log(this.config.size_limited)/Math.log(e));return result=i/Math.pow(e,n)+" "+t[n]},Duploader.prototype.get_file_broken_point=function(i){if(!this.config.chunk||!this.config.resume_broken)return 0;if(window.localStorage){var e=window.btoa(escape(i.name)+"|"+i.size),t=localStorage.getItem(e);if(t){this.debug(t);var n=JSON.parse(t);return n.index+1}return 0}},Duploader.prototype.record_file_broken_point=function(i){if(this.config.chunk&&this.config.resume_broken&&window.localStorage&&window.localStorage){var e=window.btoa(escape(i.name)+"|"+i.size);localStorage.setItem(e,JSON.stringify(i))}},Duploader.prototype.remove_file_broken_point=function(i){if(this.config.chunk&&this.config.resume_broken&&window.localStorage&&window.localStorage){var e=window.btoa(escape(i.name)+"|"+i.size);localStorage.removeItem(e)}};